<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能客服</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* 省略 CSS，保持不变 */
    </style>
</head>
<body>
    <div class="chat-container">
        <header>
            <span class="header-title">呼供小电</span>
            <span class="header-version">2.0</span>
            <div class="beta-tag">测试版</div>
        </header>
        <div class="chat-window" id="chat-box"></div>
        <div class="input-container">
            <input id="user-input" type="text" placeholder="输入消息..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()">发送</button>
        </div>
    </div>

    <script>
        let sessionId = null; // 存储 session_id

        async function sendMessage() {
            const userInput = document.getElementById("user-input");
            const message = userInput.value.trim();
            if (!message) return;

            appendMessage("user", message);
            userInput.value = "";

            const responseDiv = appendMessage("bot", "...");

            const payload = {
                input: { prompt: message },
                parameters: {},
                debug: {}
            };

            if (sessionId) {
                payload.input.session_id = sessionId; // 只有在已有 session_id 时才携带
            }

            const response = await fetch("https://2.mdznkf.xin/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                responseDiv.textContent = "服务器错误，请稍后重试！";
                return;
            }

            const responseJson = await response.json();
            const responseText = responseJson.output.text;

            // 存储 session_id，确保后续请求带上
            if (!sessionId && responseJson.output.session_id) {
                sessionId = responseJson.output.session_id;
            }

            responseDiv.innerHTML = marked.parse(responseText); // 解析 Markdown
        }

        function appendMessage(role, content) {
            const chatBox = document.getElementById("chat-box");

            // 创建消息气泡
            const messageWrapper = document.createElement("div");
            messageWrapper.classList.add(role === "user" ? "user" : "bot");

            // 解析 Markdown
            const messageDiv = document.createElement("div");
            messageDiv.innerHTML = marked.parse(content);
            messageDiv.style.whiteSpace = "normal"; // 防止文字竖排

            messageWrapper.appendChild(messageDiv);
            chatBox.appendChild(messageWrapper);
            chatBox.scrollTop = chatBox.scrollHeight; // 滚动到底部

            return messageWrapper;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
    </script>
</body>
</html>
